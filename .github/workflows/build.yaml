name: Build and Test Locust

on: [push]

env:
  locust_mc_BUILD_WITH_KASSIOPEIA: OFF
  locust_mc_ENABLE_EXECUTABLES: ON
  locust_mc_ENABLE_TESTING: ON
  locust_mc_BUILD_TYPE: Debug
  locust_mc_TAG: test

jobs:


  docker_build:
    name: Build and Test in Docker

    runs-on: ubuntu-20.04

    steps:

      - name: Checkout the repo 
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Build and test
        run: |
          docker build \
            --target locust_done \
            --build-arg build_type=${locust_mc_BUILD_TYPE} \
            --build-arg build_tests_exe=${locust_mc_ENABLE_TESTING} \
            --build-arg locust_build_with_kassiopeia=${locust_mc_BUILD_WITH_KASSIOPEIA} \
            --build-arg locust_tag=${locust_mc_TAG} \
            --tag project8/locust_mc:${locust_mc_TAG} \

          docker run project8/locust_mc:${locust_mc_TAG} /tmp_source/build/bin/testCatch            .
          docker run project8/locust_mc:${locust_mc_TAG} /tmp_source/build/bin/testFFT
          docker run project8/locust_mc:${locust_mc_TAG} /tmp_source/build/bin/testMockEGun






# For debugging
#      - name: Setup tmate session
#        if: ${{ ! success() }}
#        uses: mxschmitt/action-tmate@v3

